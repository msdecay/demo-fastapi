<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API Control Panel</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #f8f9fa;
      --card-bg: #ffffff;
      --primary-color: #007bff;
      --primary-hover: #0056b3;
      --text-color: #343a40;
      --muted-color: #6c757d;
      --border-color: #dee2e6;
      --success-color: #28a745;
      --error-color: #dc3545;
      --code-bg: #e9ecef;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      padding: 20px;
      line-height: 1.6;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
    }
    .card {
      background-color: var(--card-bg);
      border-radius: 8px;
      padding: 24px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border-color);
    }
    h1, h2 {
      margin-bottom: 16px;
      font-weight: 700;
    }
    h1 {
      font-size: 2em;
      text-align: center;
      color: var(--primary-color);
    }
    h2 {
      font-size: 1.5em;
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 8px;
    }
    .form-group {
      margin-bottom: 16px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
    }
    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 1rem;
    }
    input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }
    button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 4px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    button:hover {
      background-color: var(--primary-hover);
    }
    pre {
      background-color: var(--code-bg);
      padding: 12px;
      border-radius: 6px;
      white-space: pre-wrap;
      word-break: break-all;
      font-family: monospace;
      margin-top: 10px;
      min-height: 50px;
    }
    .status {
      display: inline-block;
      margin-left: 10px;
      font-weight: 500;
    }
    .status.success { color: var(--success-color); }
    .status.error { color: var(--error-color); }
    .token-display {
      margin-top: 12px;
      word-break: break-all;
      font-size: 0.9em;
      color: var(--muted-color);
    }
    .token-display b { color: var(--text-color); }
    .grid-2 {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="card">
      <h1>API Control Panel</h1>
      <div class="form-group">
        <label for="apiBase">Backend API Base URL:</label>
        <input id="apiBase" value="https://demo-fastapi-slc2.onrender.com">
      </div>
    </header>

    <div class="card">
        <h2>Authentication</h2>
        <div class="grid-2">
            <div>
                <h3>Register User</h3>
                <div class="form-group">
                    <label for="regUsername">Username</label>
                    <input id="regUsername" placeholder="choose a username">
                </div>
                <div class="form-group">
                    <label for="regPassword">Password</label>
                    <input id="regPassword" type="password" placeholder="choose a password">
                </div>
                <button id="btnRegister">Register</button>
                <span id="regStatus" class="status"></span>
            </div>
            <div>
                <h3>Login</h3>
                <div class="form-group">
                    <label for="username">Username</label>
                    <input id="username" value="student">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input id="password" value="demo" type="password">
                </div>
                <button id="btnLogin">Login</button>
                <div id="tokenShort" class="token-display"><b>Token:</b> (not logged in)</div>
            </div>
        </div>
    </div>

    <div class="card">
      <h2>API Interaction</h2>
       <div class="grid-2">
           <div>
                <h3>Add New Item (Requires Login)</h3>
                <div class="form-group">
                    <label for="itemName">Item Name</label>
                    <input id="itemName" placeholder="e.g., orange">
                </div>
                <button id="btnAddItem">Add Item</button>
                <span id="addStatus" class="status"></span>
           </div>
           <div>
                <h3>Test Protected Route</h3>
                <button id="btnProtected">GET /protected</button>
                <pre id="outProtected">Click to test...</pre>
           </div>
        </div>
    </div>

    <div class="card">
      <h2>General Endpoints</h2>
      <button id="btnRoot">GET / (health check)</button>
      <button id="btnItems">GET /items</button>
      <pre id="outRoot">Click an endpoint to see the response...</pre>
    </div>

  </div>

  <script>
    const outRoot = document.getElementById('outRoot');
    const outProtected = document.getElementById('outProtected');
    const tokenShort = document.getElementById('tokenShort');

    function apiBase() { return document.getElementById('apiBase').value.trim().replace(/\/+$/,''); }

    // Helper to update status elements with text and color
    function updateStatus(element, message, type) {
        element.textContent = message;
        element.className = `status ${type}`; // type can be 'success' or 'error'
    }

    async function call(path, opts = {}) {
      const url = apiBase() + path;
      const res = await fetch(url, opts);
      const text = await res.text();
      let parsed;
      try { parsed = JSON.parse(text); }
      catch(e){ parsed = text; }
      return { status: res.status, body: parsed };
    }

    /* Basic endpoints */
    document.getElementById('btnRoot').onclick = async () => {
      outRoot.textContent = "Loading...";
      const r = await call('/');
      outRoot.textContent = JSON.stringify(r, null, 2);
    };

    document.getElementById('btnItems').onclick = async () => {
      outRoot.textContent = "Loading items...";
      // Add the Authorization header if the user is logged in (token exists)
      const headers = token ? { 'Authorization': 'Bearer ' + token } : {};
      const r = await call('/items', { headers }); // <-- Pass the headers here
      outRoot.textContent = JSON.stringify(r, null, 2);
    };

    /* token stored here (shared across handlers) */
    let token = '';

    /* Login */
    document.getElementById('btnLogin').onclick = async () => {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      tokenShort.innerHTML = '<b>Token:</b> Logging in...';
      try {
        const r = await call('/login', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({username, password})
        });
        if (r.status === 200 && r.body && r.body.access_token) {
          token = r.body.access_token;
          tokenShort.innerHTML = `<b>Token:</b> <span style="color:var(--success-color)">✓ Logged in</span> (${token.slice(0,30)}...)`;
        } else {
          token = '';
          tokenShort.innerHTML = `<b>Token:</b> <span style="color:var(--error-color)">Login failed</span>`;
        }
      } catch (err) {
        token = '';
        tokenShort.innerHTML = '<b>Token:</b> <span style="color:var(--error-color)">Network error</span>';
        console.error(err);
      }
    };

    /* Protected */
    document.getElementById('btnProtected').onclick = async () => {
      outProtected.textContent = "Calling protected route...";
      if (!token) {
        outProtected.textContent = JSON.stringify({ status: 401, body: { detail: "You must login first to get a token." } }, null, 2);
        return;
      }
      const headers = { 'Authorization': 'Bearer ' + token };
      const r = await call('/protected', { headers });
      outProtected.textContent = JSON.stringify(r, null, 2);
    };

    /* Register */
    document.getElementById('btnRegister').onclick = async () => {
      const username = document.getElementById('regUsername').value.trim();
      const password = document.getElementById('regPassword').value;
      const statusEl = document.getElementById('regStatus');
      if (!username || !password) {
        updateStatus(statusEl, "Username and password required", "error");
        return;
      }
      updateStatus(statusEl, "Registering...", "");
      try {
        const res = await fetch(apiBase() + '/register', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({username, password})
        });
        const body = await res.json().catch(()=>null);
        if (res.ok) {
          updateStatus(statusEl, "Registered ✓ — now login", "success");
        } else {
          updateStatus(statusEl, "Register failed: " + (body?.detail || JSON.stringify(body)), "error");
        }
      } catch (err) {
        updateStatus(statusEl, "Network error: " + err.message, "error");
      }
    };

    /* Add Item (uses the token variable above) */
    document.getElementById('btnAddItem').onclick = async () => {
      const name = document.getElementById('itemName').value.trim();
      const s = document.getElementById('addStatus');
      if (!name) {
        updateStatus(s, "Item name required.", "error");
        return;
      }
      if (!token) {
        updateStatus(s, "Login first to get a token.", "error");
        return;
      }
      updateStatus(s, "Adding item...", "");
      try {
        const r = await fetch(apiBase() + '/add_item', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({name})
        });
        const body = await r.json().catch(()=>null);
        if (r.ok) {
          updateStatus(s, "✓ " + (body?.msg || 'Item added'), "success");
        } else {
          updateStatus(s, "✗ Error: " + (body?.detail || JSON.stringify(body)), "error");
        }
      } catch (e) {
        updateStatus(s, "Network error: " + e.message, "error");
      }
    };
  </script>
</body>
</html>
